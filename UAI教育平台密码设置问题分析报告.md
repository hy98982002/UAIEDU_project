# UAIæ•™è‚²å¹³å°å¯†ç è®¾ç½®é—®é¢˜åˆ†ææŠ¥å‘Š

## ğŸ¯ é—®é¢˜æ¦‚è¿°

**é¡¹ç›®**: UAIæ•™è‚²å¹³å° (Vue 3 + Django 5.2 + DRF)  
**é—®é¢˜**: çŸ­ä¿¡éªŒè¯ç æ³¨å†Œç”¨æˆ·é¦–æ¬¡è®¾ç½®å¯†ç æ—¶ä»æç¤º"æ—§å¯†ç å¿…å¡«"  
**æ—¶é—´**: 2025å¹´6æœˆ21æ—¥  
**å½±å“**: é˜»æ­¢ç”¨æˆ·å®Œæˆå¯†ç è®¾ç½®æµç¨‹ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ  

## ğŸ“‹ é—®é¢˜è¯¦æƒ…

### é¢„æœŸè¡Œä¸º
- ç”¨æˆ·é€šè¿‡çŸ­ä¿¡éªŒè¯ç æ³¨å†Œ (`/api/users/auth/sms-register/`)
- æ³¨å†Œæ—¶ä¸è®¾ç½®å¯†ç ï¼Œç”¨æˆ·å¯†ç å­—æ®µä¸ºç©ºæˆ–ä¸å¯ç”¨çŠ¶æ€
- é¦–æ¬¡è®¾ç½®å¯†ç æ—¶åº”è·³è¿‡æ—§å¯†ç éªŒè¯ï¼Œåªéœ€æä¾›æ–°å¯†ç 

### å®é™…è¡Œä¸º
- ç”¨æˆ·é€šè¿‡çŸ­ä¿¡éªŒè¯ç æ³¨å†ŒæˆåŠŸ
- è·å–åˆ°JWT Token
- è°ƒç”¨å¯†ç è®¾ç½®æ¥å£ (`/api/users/user/change_password/`) æ—¶
- è¿”å›400é”™è¯¯ï¼š"æ—§å¯†ç å¿…å¡«"

### é”™è¯¯å“åº”ç¤ºä¾‹
```json
{
    "status": 400,
    "msg": "å¯†ç ä¿®æ”¹/è®¾ç½®å¤±è´¥",
    "data": {
        "old_password": ["æ—§å¯†ç å¿…å¡«"]
    }
}
```

## ğŸ” é—®é¢˜åˆ†æ

### æŠ€æœ¯æ ˆä¿¡æ¯
- **åç«¯**: Django 5.2 + Django REST Framework
- **è®¤è¯**: JWT (SimpleJWT)
- **å‰ç«¯æµ‹è¯•**: Postman
- **æ•°æ®åº“**: MySQL

### ç›¸å…³ä»£ç ä½ç½®
- **åºåˆ—åŒ–å™¨**: `backend/apps/users/serializers.py` - `ChangePasswordSerializer`
- **è§†å›¾**: `backend/apps/users/views.py` - `UserViewSet.change_password`
- **URLè·¯ç”±**: `backend/apps/users/urls.py`

### é—®é¢˜é€»è¾‘
1. **ç”¨æˆ·æ³¨å†Œé€»è¾‘**:
   ```python
   # SMSRegistrationSerializer.create()
   user = User.objects.create(
       phone=phone,
       is_phone_verified=True,  
       # æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰è®¾ç½®å¯†ç 
   )
   ```

2. **å¯†ç éªŒè¯é€»è¾‘**:
   ```python
   # ChangePasswordSerializer.validate()
   if user.has_usable_password():  # è¿™é‡Œå¯èƒ½è¿”å›True
       if not old_pwd:
           raise serializers.ValidationError({"old_password": "æ—§å¯†ç å¿…å¡«"})
   ```

### å¯èƒ½åŸå› åˆ†æ
1. **ç”¨æˆ·å·²æœ‰å¯†ç **: å½“å‰Tokenå¯¹åº”çš„ç”¨æˆ·å®é™…ä¸Šå·²ç»è®¾ç½®è¿‡å¯†ç 
2. **Djangoç”¨æˆ·æ¨¡å‹è¡Œä¸º**: `has_usable_password()`æ–¹æ³•å¯èƒ½ä¸é¢„æœŸä¸ç¬¦
3. **ä»£ç ç¼“å­˜é—®é¢˜**: ä¿®æ”¹çš„ä»£ç å¯èƒ½æœªæ­£ç¡®é‡è½½
4. **æ•°æ®çŠ¶æ€é—®é¢˜**: ç”¨æˆ·æ•°æ®åº“è®°å½•çŠ¶æ€ä¸é¢„æœŸä¸ç¬¦

## ğŸ› ï¸ å·²å°è¯•çš„è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä¿®æ”¹åºåˆ—åŒ–å™¨é€»è¾‘
```python
class ChangePasswordSerializer(serializers.Serializer):
    old_password = serializers.CharField(
        required=False,  # å…è®¸ä¸ºç©º
        write_only=True,
        style={'input_type': 'password'}
    )
    
    def validate(self, attrs):
        user = self.context["request"].user
        
        # ä»…å½“ç”¨æˆ·å·²æœ‰å¯ç”¨å¯†ç æ—¶æ‰æ ¡éªŒæ—§å¯†ç 
        if user.has_usable_password():
            if not old_pwd:
                raise serializers.ValidationError({"old_password": "æ—§å¯†ç å¿…å¡«"})
        # é¦–æ¬¡è®¾ç½®å¯†ç è·³è¿‡éªŒè¯
```

### æ–¹æ¡ˆ2: ç®€åŒ–è§†å›¾é€»è¾‘
- ä½¿ç”¨åºåˆ—åŒ–å™¨çš„`save()`æ–¹æ³•
- ç§»é™¤é‡å¤çš„å¯†ç è®¾ç½®é€»è¾‘
- ç»Ÿä¸€Tokenç”Ÿæˆæœºåˆ¶

### æ–¹æ¡ˆ3: æ·»åŠ è°ƒè¯•æ—¥å¿—
```python
logger.info(f"ç”¨æˆ· {user.phone} è®¾ç½®å¯†ç  - has_usable_password: {user.has_usable_password()}")
logger.info(f"ç”¨æˆ·å¯†ç å­—æ®µ: {repr(user.password)}")
```

## ğŸ”§ å½“å‰çŠ¶æ€

### ä»£ç ä¿®æ”¹å®Œæˆ
- âœ… `ChangePasswordSerializer`é€»è¾‘å·²ä¿®æ”¹
- âœ… è§†å›¾å±‚ç®€åŒ–å®Œæˆ
- âœ… è°ƒè¯•æ—¥å¿—å·²æ·»åŠ 
- âœ… DjangoæœåŠ¡å™¨å·²é‡å¯
- âœ… **é—®é¢˜æ ¹å› å·²æ‰¾åˆ°å¹¶ä¿®å¤**

### æµ‹è¯•ç¯å¢ƒ
- âœ… DjangoæœåŠ¡å™¨è¿è¡Œåœ¨ `http://localhost:8000`
- âœ… Postman Collectionå·²åˆ›å»º
- âœ… **é—®é¢˜å·²è§£å†³**

## ğŸ¯ **é—®é¢˜è§£å†³**

### æ ¹å› å‘ç°
é€šè¿‡è°ƒè¯•è„šæœ¬å‘ç°ï¼š
- ç©ºå¯†ç å­—æ®µ(`''`)åœ¨Djangoä¸­è¢«è®¤ä¸ºæ˜¯"å¯ç”¨å¯†ç "
- `has_usable_password()`å¯¹ç©ºå­—ç¬¦ä¸²è¿”å›`True`
- çœŸæ­£çš„"ä¸å¯ç”¨å¯†ç "åº”è¯¥ä»¥`!`å¼€å¤´

### ä¿®å¤æªæ–½
1. **ä¿®æ”¹ç”¨æˆ·æ³¨å†Œé€»è¾‘**ï¼šåœ¨`SMSRegistrationSerializer.create()`ä¸­æ·»åŠ `user.set_unusable_password()`
2. **ä¿®å¤ç°æœ‰ç”¨æˆ·**ï¼šè¿è¡Œä¿®å¤è„šæœ¬å¤„ç†äº†5ä¸ªé—®é¢˜ç”¨æˆ·
3. **éªŒè¯ä¿®å¤æ•ˆæœ**ï¼šç›®æ ‡ç”¨æˆ·`18512292333`çš„`has_usable_password()`ç°åœ¨æ­£ç¡®è¿”å›`False`

## ğŸ“Š æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•æµç¨‹
1. **å‘é€æ³¨å†ŒéªŒè¯ç **
   ```
   POST /api/users/auth/send-sms/
   {
     "phone": "18512292333",
     "code_type": "register"
   }
   ```

2. **çŸ­ä¿¡éªŒè¯ç æ³¨å†Œ**
   ```
   POST /api/users/auth/sms-register/
   {
     "phone": "18512292333",
     "sms_code": "123456"
   }
   ```

3. **é¦–æ¬¡è®¾ç½®å¯†ç **
   ```
   POST /api/users/user/change_password/
   Headers: Authorization: Bearer <access_token>
   {
     "new_password": "Test123456",
     "confirm_password": "Test123456"
   }
   ```

### é¢„æœŸç»“æœ
```json
{
    "status": 200,
    "msg": "å¯†ç è®¾ç½®æˆåŠŸ",
    "data": {
        "tokens": {
            "access": "...",
            "refresh": "..."
        }
    }
}
```

## ğŸ¯ ä¸‹ä¸€æ­¥è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆA: æ•°æ®åº“å±‚é¢æ£€æŸ¥
1. æ£€æŸ¥å½“å‰ç”¨æˆ·çš„å¯†ç å­—æ®µçŠ¶æ€
2. éªŒè¯`has_usable_password()`æ–¹æ³•è¿”å›å€¼
3. ç¡®è®¤ç”¨æˆ·åˆ›å»ºæ—¶çš„åˆå§‹çŠ¶æ€

### æ–¹æ¡ˆB: å…¨æ–°ç”¨æˆ·æµ‹è¯•
1. ä½¿ç”¨æ–°æ‰‹æœºå·é‡æ–°æµ‹è¯•
2. ç¡®ä¿ç”¨æˆ·æ˜¯çœŸæ­£çš„"é¦–æ¬¡è®¾ç½®å¯†ç "çŠ¶æ€
3. è§‚å¯Ÿè°ƒè¯•æ—¥å¿—è¾“å‡º

### æ–¹æ¡ˆC: ä»£ç å±‚é¢æ·±åº¦è°ƒè¯•
1. åœ¨å…³é”®åˆ¤æ–­ç‚¹æ·»åŠ æ›´å¤šæ—¥å¿—
2. æ£€æŸ¥Djangoç”¨æˆ·æ¨¡å‹çš„é»˜è®¤è¡Œä¸º
3. éªŒè¯JWT Tokenè§£æçš„ç”¨æˆ·å¯¹è±¡

## ğŸ“ ç›¸å…³æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶
- `backend/apps/users/serializers.py` - å¯†ç è®¾ç½®åºåˆ—åŒ–å™¨
- `backend/apps/users/views.py` - ç”¨æˆ·ç®¡ç†è§†å›¾
- `backend/apps/users/models.py` - ç”¨æˆ·æ¨¡å‹å®šä¹‰
- `backend/apps/users/urls.py` - URLè·¯ç”±é…ç½®

### æµ‹è¯•æ–‡ä»¶
- `UAI_Postman_Collection_Complete.json` - å®Œæ•´APIæµ‹è¯•é›†åˆ
- ç›¸å…³çš„ç¯å¢ƒå˜é‡é…ç½®

### é…ç½®æ–‡ä»¶
- `backend/uai_backend/settings.py` - Djangoé…ç½®
- `backend/requirements.txt` - ä¾èµ–åŒ…åˆ—è¡¨

## ğŸš¨ ç´§æ€¥ç¨‹åº¦

**é«˜**: è¯¥é—®é¢˜ç›´æ¥å½±å“ç”¨æˆ·æ³¨å†Œåçš„å¯†ç è®¾ç½®æµç¨‹ï¼Œæ˜¯æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½çš„é˜»æ–­æ€§é—®é¢˜ã€‚

## ğŸ’¡ å»ºè®®

1. **ç«‹å³**: ä½¿ç”¨å…¨æ–°æ‰‹æœºå·æµ‹è¯•ï¼Œç¡®è®¤é—®é¢˜èŒƒå›´
2. **çŸ­æœŸ**: æ·»åŠ ç”¨æˆ·çŠ¶æ€æ£€æŸ¥æ¥å£ï¼Œä¾¿äºè°ƒè¯•
3. **é•¿æœŸ**: å®Œå–„ç”¨æˆ·æ³¨å†Œå’Œå¯†ç ç®¡ç†çš„æµ‹è¯•ç”¨ä¾‹

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025å¹´6æœˆ21æ—¥  
**æŠ¥å‘ŠçŠ¶æ€**: é—®é¢˜åˆ†æä¸­ï¼Œç­‰å¾…è¿›ä¸€æ­¥æµ‹è¯•éªŒè¯ 